<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Flow Designer</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="features/opportunity-view/opportunity-styles.css">
    
    <!-- D3.js for animations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- PrimeReact dependencies completely removed - not used in this application -->
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-logo">
            <img src="robobrain.svg" alt="Process Flow Designer" class="logo-image">
        </div>
        <button id="addButton" class="toolbar-button">Add</button>
        <button id="workflowButton" class="toolbar-button">Workflow</button>
        
        <input type="file" id="loadWorkflowInput" accept=".json" style="display: none;">
        <input type="file" id="appendWorkflowInput" accept=".json" style="display: none;">
        
        <select id="flowlineTypeDropdown">
            <!-- Options will be populated by config.js -->
        </select>
        
        <button id="toggleChatButton" class="toolbar-button chat-toggle">üí¨ Chat</button>
        
        <button id="eisenhowerToggle" class="toolbar-button">üìä Matrix</button>
        
        <button id="opportunityToggle" class="toolbar-button">üíº Opportunities</button>
        
        <!-- Service Health Indicators -->
        <div class="service-health">
            <div id="mcpHealthIndicator" class="health-indicator" title="MCP Services">
                <span class="health-icon">‚ö°</span>
                <span class="health-status">MCP</span>
                <span class="health-dot offline">‚óè</span>
            </div>
            <div id="ollamaHealthIndicator" class="health-indicator" title="Ollama AI">
                <span class="health-icon">ü§ñ</span>
                <span class="health-status">AI</span>
                <span class="health-dot offline">‚óè</span>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div id="canvas" class="canvas">
            <!-- Eisenhower Matrix Container -->
            <div id="eisenhowerMatrix" class="eisenhower-matrix" style="display: none;">
                <div class="quadrant quadrant-1" data-quadrant="1">
                    <div class="quadrant-label">Not Urgent & Important</div>
                </div>
                <div class="quadrant quadrant-2" data-quadrant="2">
                    <div class="quadrant-label">Urgent & Important</div>
                </div>
                <div class="quadrant quadrant-3" data-quadrant="3">
                    <div class="quadrant-label">Not Urgent & Not Important</div>
                </div>
                <div class="quadrant quadrant-4" data-quadrant="4">
                    <div class="quadrant-label">Urgent & Not Important</div>
                </div>
            </div>
            <!-- Nodes will be created here -->
        </div>
        
        <div id="chatSidebar" class="chat-sidebar">
            <div class="chat-header">
                <h3>Process Flow Assistant</h3>
                <button id="closeChatButton" class="close-chat-btn">√ó</button>
            </div>
            
            <div class="chat-status">
                <div id="chatConnectionStatus" class="connection-status">
                    <span class="status-indicator" id="statusIndicator">‚óã</span>
                    <span id="statusText">Connecting to Ollama...</span>
                </div>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <div class="welcome-message">
                    <p>üëã Hi! I'm your Process Flow Assistant.</p>
                    <p>I can help you with:</p>
                    <ul>
                        <li>Creating and managing process flows</li>
                        <li>Understanding node types and connections</li>
                        <li>Task management and tagging</li>
                        <li>Troubleshooting issues</li>
                    </ul>
                    <p>Ask me anything about your workflow!</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" 
                             class="chat-input" 
                             placeholder="Ask me about process flows, tasks, or nodes..."
                             rows="2"
                             maxlength="1000"></textarea>
                    <button id="sendChatButton" class="send-button" disabled>
                        <span id="sendButtonText">Send</span>
                        <span id="sendButtonLoader" class="loader" style="display: none;">‚óè‚óè‚óè</span>
                    </button>
                </div>
                <div class="char-counter">
                    <span id="charCount">0</span>/1000
                </div>
            </div>
        </div>
    </div>
    
    <div id="contextMenu" class="context-menu">
        <div class="menu-item" data-action="flowline">Create Flowline</div>
        <div class="menu-item" data-action="rename">Change Name</div>
        <div class="menu-item" data-action="delete">Delete Node</div>
    </div>
    
    <div id="taskContextMenu" class="context-menu">
        <div class="menu-item" data-action="advance">Advance Task</div>
        <div class="menu-item" data-action="reverse">Reverse Task</div>
        <div class="menu-item" data-action="tags">Manage Tags</div>
        <div class="menu-item" data-action="rename">Change Name</div>
        <div class="menu-item" data-action="delete">Delete Task</div>
    </div>
    
    <!-- Tag Context Menu -->
    <div id="tagContextMenu" class="context-menu tag-context-menu">
        <div class="menu-item" data-attribute="option">Edit Option</div>
        <div class="menu-item" data-attribute="date">Edit Date</div>
        <div class="menu-item" data-attribute="description">Edit Description</div>
        <div class="menu-item" data-attribute="link">Edit Link</div>
        <div class="menu-separator"></div>
        <div class="menu-item" data-action="reset-next-action" style="display: none;">Move Back to Task</div>
        <div class="menu-item" data-action="delete">Delete Tag</div>
        <div class="menu-item" data-action="close">Close</div>
    </div>
    
    <!-- Tag Attribute Options Menu -->
    <div id="tagAttributeMenu" class="context-menu tag-attribute-menu">
        <!-- Dynamic content will be populated here -->
    </div>
    
    <!-- Add Context Menu -->
    <div id="addContextMenu" class="context-menu add-context-menu">
        <div class="menu-item" data-add-type="node">Node</div>
        <div class="menu-item" data-add-type="task">Task</div>
        <div class="menu-item" data-add-type="opportunity">Opportunity</div>
    </div>
    
    <!-- Workflow Context Menu -->
    <div id="workflowContextMenu" class="context-menu workflow-context-menu">
        <div class="menu-item" data-workflow-action="save">Save Workflow</div>
        <div class="menu-item" data-workflow-action="load">Load Workflow</div>
        <div class="menu-item" data-workflow-action="append">Append Workflow</div>
    </div>
    
    <!-- Node Type Menu -->
    <div id="nodeTypeMenu" class="context-menu node-type-menu">
        <!-- Dynamic content populated by script -->
    </div>
    
    <!-- Date Picker Container -->
    <div id="tagDatePicker" class="tag-date-picker">
        <!-- PrimeReact Calendar will be rendered here -->
    </div>
    
    <!-- Tag Link Edit Modal -->
    <div id="tagLinkModal" class="modal">
        <div class="modal-content">
            <h3>Edit Tag Link</h3>
            <div class="tag-link-form">
                <label for="tagLinkEdit">Link URL:</label>
                <input type="url" id="tagLinkEdit" placeholder="https://example.com" class="tag-link-input">
            </div>
            <div class="modal-buttons">
                <button id="tagLinkModalCancel" class="modal-button cancel">Cancel</button>
                <button id="tagLinkModalSave" class="modal-button create">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Tag Description Edit Modal -->
    <div id="tagDescriptionModal" class="modal">
        <div class="modal-content">
            <h3>Edit Tag Description</h3>
            <div class="tag-description-form">
                <label for="tagDescriptionEdit">Description:</label>
                <textarea id="tagDescriptionEdit" placeholder="Enter tag description..." class="tag-description-input" rows="4"></textarea>
            </div>
            <div class="modal-buttons">
                <button id="tagDescriptionModalCancel" class="modal-button cancel">Cancel</button>
                <button id="tagDescriptionModalSave" class="modal-button create">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Tag Date Edit Modal -->
    <div id="tagDateModal" class="modal">
        <div class="modal-content">
            <h3>Edit Tag Date</h3>
            <div class="tag-date-form">
                <label for="tagDateCalendar">Select Date:</label>
                <div id="tagDateCalendar" class="tag-date-calendar-container"></div>
            </div>
            <div class="modal-buttons">
                <button id="tagDateModalCancel" class="modal-button cancel">Cancel</button>
                <button id="tagDateModalClear" class="modal-button secondary">Clear Date</button>
                <button id="tagDateModalSave" class="modal-button create">Save</button>
            </div>
        </div>
    </div>
    
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3>Add New Task</h3>
            <input type="text" id="taskNameInput" placeholder="Enter task name..." maxlength="50">
            <div class="modal-buttons">
                <button id="taskModalCancel" class="modal-button cancel">Cancel</button>
                <button id="taskModalCreate" class="modal-button create">Create Task</button>
            </div>
        </div>
    </div>
    
    <div id="taskEditModal" class="modal">
        <div class="modal-content">
            <h3>Edit Task</h3>
            <div class="task-edit-form">
                <div class="form-group">
                    <label for="taskEditName">Task Name (required):</label>
                    <input type="text" id="taskEditName" placeholder="Enter task name..." maxlength="100" required>
                </div>
                
                <div class="form-group">
                    <label for="taskEditDescription">Description (optional):</label>
                    <textarea id="taskEditDescription" placeholder="Enter task description..." rows="3" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="taskEditStatus">Status:</label>
                    <select id="taskEditStatus">
                        <option value="not_started">Not Started</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="on_hold">On Hold</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskEditPriority">Priority:</label>
                    <select id="taskEditPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskEditDueDate">Due Date (optional):</label>
                    <input type="date" id="taskEditDueDate">
                </div>
                
                <div class="form-group">
                    <label for="taskEditOpportunity">Linked Opportunity (optional):</label>
                    <select id="taskEditOpportunity">
                        <option value="">No opportunity linked</option>
                        <!-- Opportunities will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskEditEstimatedHours">Estimated Hours (optional):</label>
                    <input type="number" id="taskEditEstimatedHours" placeholder="Enter estimated hours..." min="0" step="0.5">
                </div>
                
                <div class="form-group">
                    <label for="taskEditAssignedTo">Assigned To (optional):</label>
                    <input type="text" id="taskEditAssignedTo" placeholder="Enter assignee name..." maxlength="100">
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="taskEditModalCancel" class="modal-button cancel">Cancel</button>
                <button id="taskEditModalSave" class="modal-button create">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="advanceTaskModal" class="modal">
        <div class="modal-content">
            <h3>Advance Task</h3>
            <p>Select which node to advance the task to:</p>
            <div id="advanceOptions"></div>
            <div class="modal-buttons">
                <button id="advanceModalCancel" class="modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="reassignTasksModal" class="modal">
        <div class="modal-content">
            <h3>Reassign Tasks</h3>
            <p id="reassignTasksMessage">The node you are deleting has associated tasks. Select which node to reassign them to:</p>
            <div id="reassignTasksList" class="reassign-tasks-list"></div>
            <div id="reassignOptions" class="reassign-options"></div>
            <div class="modal-buttons">
                <button id="reassignModalCancel" class="modal-button cancel">Cancel</button>
                <button id="reassignModalConfirm" class="modal-button confirm" disabled>Reassign & Delete</button>
            </div>
        </div>
    </div>
    
    <div id="tagModal" class="modal">
        <div class="modal-content">
            <h3>Manage Task Tags</h3>
            <div id="currentTags" class="current-tags">
                <!-- Current tags will be displayed here -->
            </div>
            
            <div class="tag-form">
                <h4>Add New Tag</h4>
                <div class="tag-selectors">
                    <select id="tagCategoryDropdown">
                        <!-- Options will be populated by config.js -->
                    </select>
                    <select id="tagOptionDropdown" disabled>
                        <!-- Options will be populated based on category selection -->
                    </select>
                    <div class="tag-date-selector">
                        <label for="tagDateInput">Date (optional):</label>
                        <input type="date" id="tagDateInput" class="tag-date-input">
                    </div>
                    <div class="tag-description-selector">
                        <label for="tagDescriptionInput">Description (optional):</label>
                        <textarea id="tagDescriptionInput" class="tag-description-input" placeholder="Enter tag description..." rows="3"></textarea>
                    </div>
                    <div class="tag-link-selector">
                        <label for="tagLinkInput">Link (optional):</label>
                        <input type="url" id="tagLinkInput" class="tag-link-input" placeholder="https://example.com">
                    </div>
                    
                    <!-- Custom fields for advanced tag types -->
                    <div id="tagCustomFields" class="tag-custom-fields" style="display: none;">
                        <!-- SharePoint specific fields -->
                        <div class="custom-field sharepoint-field" data-category="sharepoint" style="display: none;">
                            <label for="tagSharePointName">SharePoint Name (required):</label>
                            <input type="text" id="tagSharePointName" class="custom-field-input" placeholder="Enter SharePoint item name">
                        </div>
                        
                        <!-- CRM specific fields -->
                        <div class="custom-field crm-field" data-category="crm" style="display: none;">
                            <label for="tagCrmOpportunityId">Opportunity ID (required):</label>
                            <input type="text" id="tagCrmOpportunityId" class="custom-field-input" placeholder="Enter opportunity ID">
                        </div>
                        
                        <!-- Confluence specific fields -->
                        <div class="custom-field confluence-field" data-category="confluence" style="display: none;">
                            <label for="tagConfluenceName">Confluence Name (required):</label>
                            <input type="text" id="tagConfluenceName" class="custom-field-input" placeholder="Enter page/document name">
                            
                            <label for="tagConfluenceAuthor">Author (optional):</label>
                            <input type="text" id="tagConfluenceAuthor" class="custom-field-input" placeholder="Enter author name">
                        </div>
                    </div>
                    
                    <div class="tag-completed-selector">
                        <label class="checkbox-label">
                            <input type="checkbox" id="tagCompletedInput" class="tag-completed-input">
                            <span class="checkmark"></span>
                            Mark as completed
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="tagModalCancel" class="modal-button cancel">Cancel</button>
                <button id="tagModalAdd" class="modal-button create">Add Tag</button>
                <button id="tagModalSave" class="modal-button create">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="opportunityModal" class="modal">
        <div class="modal-content">
            <h3>Create New Opportunity</h3>
            <div class="opportunity-form">
                <div class="form-group">
                    <label for="opportunityTitle">Title (required):</label>
                    <input type="text" id="opportunityTitle" placeholder="Enter opportunity title..." maxlength="100" required>
                </div>
                
                <div class="form-group">
                    <label for="opportunityDescription">Description (required):</label>
                    <textarea id="opportunityDescription" placeholder="Enter detailed description..." rows="4" maxlength="500" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="opportunityStatus">Status:</label>
                    <select id="opportunityStatus" required>
                        <option value="active">Active</option>
                        <option value="planning">Planning</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="opportunityTags">Tags (comma-separated):</label>
                    <input type="text" id="opportunityTags" placeholder="e.g., partnership, technology, high-priority">
                </div>
                
                <div class="form-group">
                    <label for="opportunityValue">Value (optional):</label>
                    <input type="number" id="opportunityValue" placeholder="Enter monetary value..." min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="opportunityPriority">Priority:</label>
                    <select id="opportunityPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="opportunityDeadline">Deadline (optional):</label>
                    <input type="date" id="opportunityDeadline">
                </div>
                
                <div class="form-group">
                    <label for="opportunityContact">Contact Person (optional):</label>
                    <input type="text" id="opportunityContact" placeholder="Enter contact person name..." maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="opportunityNotes">Notes (optional):</label>
                    <textarea id="opportunityNotes" placeholder="Additional notes..." rows="3" maxlength="1000"></textarea>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="opportunityModalCancel" class="modal-button cancel">Cancel</button>
                <button id="opportunityModalExport" class="modal-button secondary">Create & Export JSON</button>
                <button id="opportunityModalCreate" class="modal-button create">Create Opportunity</button>
            </div>
        </div>
    </div>
    
    <script src="config.js"></script>
    
    <!-- Utility Modules (Phase 2: Safe Modularization) -->
    <script src="utils/geometry-utils.js"></script>
    <script src="utils/validation-utils.js"></script>
    <script src="utils/dom-utils.js"></script>
    
    <!-- Service Modules (Phase 3: Configuration Management) -->
    <script src="services/config-service.js"></script>
    <script src="services/dom-service.js"></script>
    <script src="services/relationship-tracker.js"></script>
    
    <!-- UI Modules (Phase 4: Modal System Extraction) -->
    <script src="ui/modal-manager.js"></script>
    
    <!-- UI Modules (Phase 5: Context Menu Extraction) -->
    <script src="ui/context-menu-manager.js"></script>
    
    <!-- Feature Modules (Phase 6: Tag System Extraction) -->
    <script src="features/tag-manager.js"></script>
    
    <!-- Feature Modules (Phase 7: Eisenhower Matrix Extraction) -->
    <script src="features/eisenhower-matrix/matrix-animations.js"></script>
    <script src="features/eisenhower-matrix/matrix-controller.js"></script>
    
    <!-- Feature Modules (Opportunity View System) -->
    <script src="features/opportunity-view/opportunity-controller.js"></script>
    
    <!-- Feature Modules (Phase 8: Node Management System) -->
    <script src="features/node-management/node-factory.js"></script>
    <script src="features/node-management/node-manager.js"></script>
    
    <!-- Feature Modules (Phase 9: Flowline System) -->
    <script src="features/flowline-system/flowline-renderer.js"></script>
    <script src="features/flowline-system/flowline-manager.js"></script>
    
    <!-- MCP Integration -->
    <script src="services/mcp-client.js"></script>
    <script src="services/workflow-bridge.js"></script>
    <script src="services/health-manager.js"></script>
    <script src="test-mcp-integration.js"></script>
    
    <script src="chat-interface.js"></script>
    <script src="script.js"></script>
    
    <!-- Phase 5 Context Menu Verification -->
    <script src="tests/phase5-context-menu-verification.js"></script>
    
    <!-- Phase 6 Tag System Verification -->
    <script src="tests/phase6-tag-system-verification.js"></script>
    
    <!-- Phase 7 Eisenhower Matrix Verification -->
    <script src="tests/phase7-matrix-verification.js"></script>
    
    <!-- Phase 8 Node Management Verification -->
    <script src="tests/phase8-node-verification.js"></script>
    
    <!-- Phase 9 Flowline System Verification -->
    <script src="tests/phase9-flowline-verification.js"></script>
    
    <!-- Debug and test scripts removed to clean up console errors -->
    
    <!-- Workflow Commands Integration Test -->
    <script src="test-workflow-commands.js"></script>
    
</body>
</html>
