<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Flow Designer</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- D3.js for animations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- PrimeReact Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/primereact/resources/themes/lara-light-cyan/theme.css" />
    <link rel="stylesheet" href="https://unpkg.com/primereact/resources/primereact.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/primeicons/primeicons.css" />
    <script src="https://unpkg.com/primereact/api/api.min.js"></script>
    <script src="https://unpkg.com/primereact/calendar/calendar.min.js"></script>
</head>
<body>
    <div class="toolbar">
        <select id="nodeTypeDropdown">
            <!-- Options will be populated by config.js -->
        </select>
        
        <button id="addTaskButton" class="toolbar-button">Add Task</button>
        
        <button id="saveWorkflowButton" class="toolbar-button">Save Workflow</button>
        <button id="loadWorkflowButton" class="toolbar-button">Load Workflow</button>
        <input type="file" id="loadWorkflowInput" accept=".json" style="display: none;">
        
        <select id="flowlineTypeDropdown">
            <!-- Options will be populated by config.js -->
        </select>
        
        <button id="toggleChatButton" class="toolbar-button chat-toggle">üí¨ Chat</button>
        
        <button id="eisenhowerToggle" class="toolbar-button">üìä Matrix</button>
    </div>
    
    <div class="main-container">
        <div id="canvas" class="canvas">
            <!-- Eisenhower Matrix Container -->
            <div id="eisenhowerMatrix" class="eisenhower-matrix" style="display: none;">
                <div class="quadrant quadrant-1" data-quadrant="1">
                    <div class="quadrant-label">Not Urgent & Important</div>
                </div>
                <div class="quadrant quadrant-2" data-quadrant="2">
                    <div class="quadrant-label">Urgent & Important</div>
                </div>
                <div class="quadrant quadrant-3" data-quadrant="3">
                    <div class="quadrant-label">Not Urgent & Not Important</div>
                </div>
                <div class="quadrant quadrant-4" data-quadrant="4">
                    <div class="quadrant-label">Urgent & Not Important</div>
                </div>
            </div>
            <!-- Nodes will be created here -->
        </div>
        
        <div id="chatSidebar" class="chat-sidebar">
            <div class="chat-header">
                <h3>Process Flow Assistant</h3>
                <button id="closeChatButton" class="close-chat-btn">√ó</button>
            </div>
            
            <div class="chat-status">
                <div id="chatConnectionStatus" class="connection-status">
                    <span class="status-indicator" id="statusIndicator">‚óã</span>
                    <span id="statusText">Connecting to Ollama...</span>
                    <button id="retryConnectionButton" class="retry-connection-btn" style="display: none;">Retry</button>
                </div>
                <div class="model-selector">
                    <label for="modelSelect">Model:</label>
                    <select id="modelSelect" class="model-select">
                        <option value="smollm2:135m">smollm2:135m (loading...)</option>
                    </select>
                </div>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <div class="welcome-message">
                    <p>üëã Hi! I'm your Process Flow Assistant.</p>
                    <p>I can help you with:</p>
                    <ul>
                        <li>Creating and managing process flows</li>
                        <li>Understanding node types and connections</li>
                        <li>Task management and tagging</li>
                        <li>Troubleshooting issues</li>
                    </ul>
                    <p>Ask me anything about your workflow!</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" 
                             class="chat-input" 
                             placeholder="Ask me about process flows, tasks, or nodes..."
                             rows="2"
                             maxlength="1000"></textarea>
                    <button id="sendChatButton" class="send-button" disabled>
                        <span id="sendButtonText">Send</span>
                        <span id="sendButtonLoader" class="loader" style="display: none;">‚óè‚óè‚óè</span>
                    </button>
                </div>
                <div class="char-counter">
                    <span id="charCount">0</span>/1000
                </div>
            </div>
        </div>
    </div>
    
    <div id="contextMenu" class="context-menu">
        <div class="menu-item" data-action="flowline">Create Flowline</div>
        <div class="menu-item" data-action="rename">Change Name</div>
        <div class="menu-item" data-action="delete">Delete Node</div>
    </div>
    
    <div id="taskContextMenu" class="context-menu">
        <div class="menu-item" data-action="advance">Advance Task</div>
        <div class="menu-item" data-action="reverse">Reverse Task</div>
        <div class="menu-item" data-action="tags">Manage Tags</div>
        <div class="menu-item" data-action="rename">Change Name</div>
        <div class="menu-item" data-action="delete">Delete Task</div>
    </div>
    
    <!-- Tag Context Menu -->
    <div id="tagContextMenu" class="context-menu tag-context-menu">
        <!-- Content will be dynamically populated by ContextMenuManager -->
    </div>
    
    <!-- Tag Attribute Options Menu -->
    <div id="tagAttributeMenu" class="context-menu tag-attribute-menu">
        <!-- Dynamic content will be populated here -->
    </div>
    
    <!-- Date Picker Container -->
    <div id="tagDatePicker" class="tag-date-picker">
        <!-- PrimeReact Calendar will be rendered here -->
    </div>
    
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3>Add New Task</h3>
            <input type="text" id="taskNameInput" placeholder="Enter task name..." maxlength="50">
            <div class="modal-buttons">
                <button id="taskModalCancel" class="modal-button cancel">Cancel</button>
                <button id="taskModalCreate" class="modal-button create">Create Task</button>
            </div>
        </div>
    </div>
    
    <div id="advanceTaskModal" class="modal">
        <div class="modal-content">
            <h3>Advance Task</h3>
            <p>Select which node to advance the task to:</p>
            <div id="advanceOptions"></div>
            <div class="modal-buttons">
                <button id="advanceModalCancel" class="modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="reassignTasksModal" class="modal">
        <div class="modal-content">
            <h3>Reassign Tasks</h3>
            <p id="reassignTasksMessage">The node you are deleting has associated tasks. Select which node to reassign them to:</p>
            <div id="reassignTasksList" class="reassign-tasks-list"></div>
            <div id="reassignOptions" class="reassign-options"></div>
            <div class="modal-buttons">
                <button id="reassignModalCancel" class="modal-button cancel">Cancel</button>
                <button id="reassignModalConfirm" class="modal-button confirm" disabled>Reassign & Delete</button>
            </div>
        </div>
    </div>
    
    <div id="tagModal" class="modal">
        <div class="modal-content">
            <h3>Manage Task Tags</h3>
            <div id="currentTags" class="current-tags">
                <!-- Current tags will be displayed here -->
            </div>
            
            <div class="tag-form">
                <h4>Add New Tag</h4>
                <div class="tag-selectors">
                    <select id="tagCategoryDropdown">
                        <!-- Options will be populated by config.js -->
                    </select>
                    <select id="tagOptionDropdown" disabled>
                        <!-- Options will be populated based on category selection -->
                    </select>
                    <div class="tag-date-selector">
                        <label for="tagDateInput">Date (optional):</label>
                        <input type="date" id="tagDateInput" class="tag-date-input">
                    </div>
                    <div class="tag-description-selector">
                        <label for="tagDescriptionInput">Description (optional):</label>
                        <textarea id="tagDescriptionInput" class="tag-description-input" placeholder="Enter tag description..." rows="3"></textarea>
                    </div>
                    <div class="tag-link-selector">
                        <label for="tagLinkInput">Link (optional):</label>
                        <input type="url" id="tagLinkInput" class="tag-link-input" placeholder="https://example.com">
                    </div>
                    <div class="tag-completed-selector">
                        <label class="checkbox-label">
                            <input type="checkbox" id="tagCompletedInput" class="tag-completed-input">
                            <span class="checkmark"></span>
                            Mark as completed
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="tagModalCancel" class="modal-button cancel">Cancel</button>
                <button id="tagModalAdd" class="modal-button create">Add Tag</button>
                <button id="tagModalSave" class="modal-button create">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script src="config.js"></script>
    
    <!-- Utility Modules (Phase 2: Safe Modularization) -->
    <script src="utils/geometry-utils.js"></script>
    <script src="utils/validation-utils.js"></script>
    <script src="utils/dom-utils.js"></script>
    
    <!-- Service Modules (Phase 3: Configuration Management) -->
    <script src="services/config-service.js"></script>
    <script src="services/dom-service.js"></script>
    
    <!-- UI Modules (Phase 4: Modal System Extraction) -->
    <script src="ui/modal-manager.js"></script>
    
    <!-- UI Modules (Phase 5: Context Menu Extraction) -->
    <script src="ui/context-menu-manager.js"></script>
    
    <!-- Feature Modules (Phase 6: Tag System Extraction) -->
    <script src="features/tag-manager.js"></script>
    
    <!-- Feature Modules (Phase 7: Eisenhower Matrix Extraction) -->
    <script src="features/eisenhower-matrix/matrix-animations.js"></script>
    <script src="features/eisenhower-matrix/matrix-controller.js"></script>
    
    <!-- Feature Modules (Phase 8: Node Management System) -->
    <script src="features/node-management/node-factory.js"></script>
    <script src="features/node-management/node-manager.js"></script>
    
    <!-- Feature Modules (Phase 9: Flowline System) -->
    <script src="features/flowline-system/flowline-renderer.js"></script>
    <script src="features/flowline-system/flowline-manager.js"></script>
    
    <!-- Feature Modules (Phase 10: Note-Taking System) -->
    <script src="features/note-taking/command-parser.js"></script>
    <script src="features/note-taking/note-storage.js"></script>
    <script src="features/note-taking/note-manager.js"></script>
    
    <script src="chat-interface.js"></script>
    <script src="script.js"></script>
</body>
</html>